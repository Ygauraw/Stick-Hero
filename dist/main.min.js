$(function(){"use strict";function a(a){this.options=a||{};var b=320,c=480,d=this.options.width||b,e=this.options.height||c,f=d/b,g=e/c,h=50*f,i=100*g,j=18*f,k=24*f,l=5,m=i+l,n=j+2,o=3,p=h-o,q=i,r=4,s=h-j-r-o,t=h-o,u=h+20,v=d-h,w=15*f,x=69*f,y=3,z="transitionend webkitTransitionEnd animationend webkitAnimationEnd MSAnimationEnd oAnimationEnd",A="",B={},C=!!navigator.userAgent.match(/MicroMessenger/),D={WELCOME:0,PRE_BEGIN:1,BEGIN:2,STICK_ROTATION:3,HERO_WALK:4,SHIFTING:5,DYING:6,UPDATE:7,DEAD:8};return this.init=function(){this.initVars(),this.bindEvents(),this.reset()},this.initVars=function(){this.$title=$("title"),A=this.$title.text(),this.$copyright=$(".copyright"),this.$game=$("#game").css({width:d+"px",height:e+"px"}),this.$name=$(".name"),this.$hero=$(".hero1").css({width:j+"px",height:k+"px"}),this.$ribbon=$(".hero1 .ribbon").css({width:n+"px"}),this.$feet=$(".foot"),this.$gameover=$(".game-over"),this.$welcome=$(".welcome"),this.$share=$(".share"),this.$liveScore=$(".live-score"),this.$instruction=$(".instruction"),this.$score=$(".score"),this.$best=$(".best"),this.$movedStick=$("nothing"),this.main=$.proxy(this.mainLoop,this),this._currentState=D.WELCOME,this._pressStarted=!1,this._firstRun=!0},this.bindEvents=function(){var a=this;$(document).on("keypress",function(b){32===b.keyCode&&(a._currentState===D.WELCOME?$(".btn-play").trigger("click"):a._currentState===D.DEAD&&$(".btn-playagain").trigger("click"))}),$(document).on("click",".btn-play",function(){a.nextAfterAnimated(a.$name,D.PRE_BEGIN),a.$name.addClass("hinge")}),$(document).on("click",".btn-playagain",function(){a.reset(),a.next(D.PRE_BEGIN)}),$(document).on("click",".btn-share",function(){a.$share.show()}),$(document).on("click touchstart",".share.overlay",function(){a.$share.hide()}),$(document).on("keypress",function(a){B[a.keyCode]=!0}),$(document).on("keyup",function(a){B[a.keyCode]=!1}),$(document).on("touchstart",function(){B.touching=!0}),$(document).on("touchend",function(){B.touching=!1})},this.reset=function(){this.score=0,this.best=localStorage.getItem("best")||0,this.bg="bg"+this._getRandom(1,5),this.$title.text(A),this.$game.removeClass("bounce bg1 bg2 bg3 bg4 bg5").addClass(this.bg),this.$liveScore.hide(),this.$gameover.hide(),this.$welcome.hide(),this.updateScore(),$(".box, .stick").remove(),this.$feet.removeClass("walk"),this.$box1=$("<div />").addClass("box").css({height:i+"px",left:(d-h)/2+"px",width:h+"px"}),this.$hero.css({bottom:m+"px",left:(d-j)/2+"px"}),this.$game.append(this.$box1)},this.mainLoop=function(){switch(this._currentState){case D.WELCOME:this.welcomeState();break;case D.PRE_BEGIN:this.preBeginState();break;case D.BEGIN:this.beginState();break;case D.STICK_ROTATION:this.stickRotationState();break;case D.HERO_WALK:this.heroWalkState();break;case D.SHIFTING:this.shiftingState();break;case D.DYING:this.dyingState();break;case D.UPDATE:this.updateState();break;case D.DEAD:this.deadState()}this.isContinue()&&this.play()},this.play=function(){window.requestAnimationFrame(this.main)},this.isContinue=function(){return!0},this.next=function(a){if(this._firstRun=!0,void 0!==a)return void(this._currentState=a);var b=Object.keys(D).length-1;this._currentState===b?this._currentState=0:this._currentState++},this.nextAfterAnimated=function(a,b){var c=this;a.on(z,function(){a.off(z),c.next(b)})},this.welcomeState=function(){this.$gameover.hide(),this.$liveScore.hide(),this.$welcome.show()},this.preBeginState=function(){if(this._firstRun){this.$welcome.hide(),this.$gameover.hide(),this.$copyright.hide(),this.$liveScore.show(),this._createBox(),this.$box2=$("<div />").addClass("box").css({height:i+"px",width:this._newBox.width+"px",left:"250%"}),this.$game.append(this.$box2),this.nextAfterAnimated(this.$box2),this.$hero.addClass("shift").css({left:h-j-r-o+"px"}),this.$box1.css({left:0}),this.$instruction.addClass("in");var a=this;setTimeout(function(){a.$box2.css("left",a._newBox.left+"px")},0),this._firstRun=!1}},this.beginState=function(){return this._firstRun&&(this._activeStickHeight=0,this._validStickMin=this._newBox.left-h,this._validStickMax=this._validStickMin+this._newBox.width,this.$hero.removeClass("shift"),this.$activeStick=$("<div />").addClass("stick").css({left:p+"px",bottom:q+"px"}),this.$game.append(this.$activeStick),this._firstRun=!1),this._isPressed()?(this.$hero.parent().addClass("shake"),this.$instruction.removeClass("in"),this._activeStickHeight+=y,this.$activeStick.css("height",this._activeStickHeight+"px"),void(this._pressStarted=!0)):void(this._pressStarted&&(this.$hero.parent().removeClass("shake"),this._pressStarted=!1,this.next()))},this.stickRotationState=function(){this._firstRun&&(this.nextAfterAnimated(this.$activeStick),this.$activeStick.addClass("rotate"),this._firstRun=!1)},this.heroWalkState=function(){this._firstRun&&(this.$feet.addClass("walk"),this.dx=this._newBox.left+this._newBox.width-h,this._activeStickHeight>this._validStickMin&&this._activeStickHeight<this._validStickMax?(this.nextAfterAnimated(this.$hero,D.SHIFTING),this.$hero.css("left",s+this.dx+"px")):(this.nextAfterAnimated(this.$hero,D.DYING),this.$hero.css("left",s+r+j+this._activeStickHeight+"px")),this._firstRun=!1)},this.shiftingState=function(){if(this._firstRun){this.nextAfterAnimated(this.$hero,D.UPDATE),this._createBox(),this.$feet.removeClass("walk"),this.$hero.addClass("shift").css("left",parseInt(this.$hero.css("left"),10)-this.dx+"px"),this.$box1.css("left",parseInt(this.$box1.css("left"),10)-this.dx+"px"),this.$box2.css("left",parseInt(this.$box2.css("left"),10)-this.dx+"px"),this.$movedStick.css("left",parseInt(this.$movedStick.css("left"),10)-this.dx+"px"),this.$box3=$("<div />").addClass("box").css({height:i+"px",width:this._newBox.width+"px",left:"200%"}),this.$game.append(this.$box3);var a=this;setTimeout(function(){a.$box3.css("left",a._newBox.left+"px")},0),this.$activeStick.css("left",t-this.dx+"px"),this._firstRun=!1}},this.dyingState=function(){this._firstRun&&(this.nextAfterAnimated(this.$hero,D.DEAD),this.$hero.css("bottom",-k+"px"),this.$activeStick.addClass("died"),this._firstRun=!1)},this.updateState=function(){this.score++,this.updateScore(),this.$hero.removeClass("shift"),this.$box1.remove(),this.$box1=this.$box2,this.$box2=this.$box3,this.$movedStick.remove(),this.$movedStick=this.$activeStick,this.next(D.BEGIN)},this.deadState=function(){this.$liveScore.hide(),this.$gameover.show(),this.$game.addClass("bounce"),C&&this.$title.text(A+": 我一不小心就前进了"+self.score+"步，你敢挑战我吗？小伙伴们快来一起玩耍吧！")},this.updateScore=function(){this.best<this.score&&(this.best=this.score,localStorage.setItem("best",this.best)),this.$liveScore.text(this.score),this.$score.text(this.score),this.$best.text(this.best)},this._isPressed=function(){return B[32]||B.touching},this._createBox=function(){this._newBox={left:this._getRandom(u,v),width:this._getRandom(w,x)}},this._getRandom=function(a,b){return Math.floor(Math.random()*(b-a+1))+a},this.init(),this}var b=$(window).width(),c=$(window).height(),d={};c>b&&500>b&&(d.width=b,d.height=c),new a(d).play()});